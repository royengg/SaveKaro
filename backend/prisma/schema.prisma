generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User & Authentication

model User {
  id        String  @id @default(cuid())
  email     String  @unique
  name      String?
  avatarUrl String?
  googleId  String  @unique

  // Relationships
  savedDeals     SavedDeal[]
  upvotes        Upvote[]
  comments       Comment[]
  submittedDeals Deal[]        @relation("SubmittedDeals")
  notifications    Notification[]
  preferences      UserPreference?
  sessions         Session[]
  
  // Gamification
  isAdmin          Boolean          @default(false)
  stats            UserStats?
  badges           UserBadge[]
  challengeEntries ChallengeEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

// Deals

model Deal {
  id              String     @id @default(cuid())
  title           String
  description     String?
  originalPrice   Decimal?   @db.Decimal(10, 2)
  dealPrice       Decimal?   @db.Decimal(10, 2)
  discountPercent Int?
  productUrl      String
  imageUrl        String?
  store           String? // Amazon, Flipkart, etc.
  source          DealSource @default(REDDIT)
  region          DealRegion @default(INDIA)
  currency        String     @default("INR") // ISO code: INR, USD, EUR, GBP
  redditPostId    String?    @unique // For deduplication
  redditScore     Int        @default(0)

  // Relationships
  category      Category @relation(fields: [categoryId], references: [id])
  categoryId    String
  submittedBy   User?    @relation("SubmittedDeals", fields: [submittedById], references: [id])
  submittedById String?
  savedBy       SavedDeal[]
  upvotes       Upvote[]
  comments      Comment[]
  priceHistory  PriceHistory[]

  // Metrics
  clickCount    Int @default(0)
  upvoteCount   Int @default(0)
  downvoteCount Int @default(0)

  // Status & Gamification
  status           DealStatus       @default(ACTIVE)
  challengeEntries ChallengeEntry[]

  isActive  Boolean   @default(true)
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([categoryId])
  @@index([createdAt])
  @@index([store])
  @@index([region])
  @@index([isActive, createdAt])
}

enum DealSource {
  REDDIT
  USER_SUBMITTED
}

enum DealRegion {
  INDIA
  WORLD
}

// Categories

model Category {
  id    String  @id @default(cuid())
  name  String  @unique
  slug  String  @unique
  icon  String?
  color String? // For UI theming

  deals Deal[]

  createdAt DateTime @default(now())
}

// User Engagement

model SavedDeal {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  dealId String

  createdAt DateTime @default(now())

  @@unique([userId, dealId])
  @@index([userId])
}

model Upvote {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  dealId String
  value  Int    @default(1) // 1 for upvote, -1 for downvote

  createdAt DateTime @default(now())

  @@unique([userId, dealId])
  @@index([dealId])
}

model Comment {
  id      String @id @default(cuid())
  content String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  String
  deal    Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  dealId  String

  // For nested comments
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  parentId String?
  replies  Comment[] @relation("CommentReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealId])
  @@index([userId])
}

// Price Tracking

model PriceHistory {
  id     String  @id @default(cuid())
  deal   Deal    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  dealId String
  price  Decimal @db.Decimal(10, 2)
  source String? // Where price was captured from

  createdAt DateTime @default(now())

  @@index([dealId, createdAt])
}

model UserPreference {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  // Notification preferences
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(false)

  // Category preferences (store as JSON array of category IDs)
  preferredCategories String[] @default([])

  // Price alert threshold
  minDiscountPercent Int @default(30)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

  model Notification {
  id      String           @id @default(cuid())
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  String
  type    NotificationType
  title   String
  message String
  data    Json? // For storing deal ID, etc.
  isRead  Boolean          @default(false)

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  NEW_DEAL
  PRICE_DROP
  COMMENT_REPLY
  DEAL_UPVOTED
  SYSTEM
}

// Session Management (for OAuth)
  

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime

  @@index([userId])
}

// System Settings

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

// Gamification Models

model UserStats {
  id              String @id @default(cuid())
  user            User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String @unique
  
  // Rolling 7-day metrics
  weeklyUpvotes   Int    @default(0)   // Sum of upvotes on user's deals
  weeklyDownvotes Int    @default(0)   // Sum of downvotes  
  weeklyDeals     Int    @default(0)   // Deals submitted this week
  
  // Penalties
  expiredPenalty  Int    @default(0)   // -5 each
  fakePenalty     Int    @default(0)   // -25 each
  
  // Calculated score (updated on vote events)
  reputationScore Int    @default(0)
  
  // Ranking (updated by batch job)
  weeklyRank      Int?
  
  lastUpdated     DateTime @default(now())
  
  @@index([reputationScore(sort: Desc)])
  @@index([weeklyRank])
}

model Badge {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  icon        String    // emoji or icon name
  description String
  tier        BadgeTier
  criteria    Json      // {type: "reputation", threshold: 100}
  
  users       UserBadge[]
  createdAt   DateTime  @default(now())
}

enum BadgeTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

model UserBadge {
  id       String   @id @default(cuid())
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String
  badge    Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  badgeId  String
  earnedAt DateTime @default(now())
  
  @@unique([userId, badgeId])
  @@index([userId])
}

model Challenge {
  id          String   @id @default(cuid())
  title       String
  description String
  criteria    Json     // {category: "tech", maxPrice: 1000, minDiscount: 30}
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  
  entries     ChallengeEntry[]
  createdAt   DateTime @default(now())
  
  @@index([isActive, endDate])
}

model ChallengeEntry {
  id          String    @id @default(cuid())
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  challengeId String
  deal        Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  dealId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  
  // Score = upvotes / price Ã— 1000
  valueScore  Float     @default(0)
  
  createdAt   DateTime  @default(now())
  
  @@unique([challengeId, dealId])
  @@index([challengeId, valueScore(sort: Desc)])
}

enum DealStatus {
  ACTIVE
  EXPIRED
  FAKE
}
